# Enterprise Multi-Environment DataOps Pipeline
# DEV â†’ PRE-PROD â†’ PROD deployment workflow

trigger:
- main
- develop

pool:
  name: 'Default'  # Your existing Mac agent

variables:
  sqlServerName: 'sqlserver-dataops-demo-milan.database.windows.net'
  majorVersion: '1'
  minorVersion: '0'
  patchVersion: $[counter(format('{0}.{1}', variables['majorVersion'], variables['minorVersion']), 1)]

stages:
#==========================================
# DEV ENVIRONMENT (Auto-deploy always)
#==========================================
- stage: DeployDev
  displayName: 'ðŸ”§ Deploy to Development'
  condition: always()
  variables:
  - template: environments/dev/config.yml
  jobs:
  - job: DeployToDevDB
    displayName: 'Deploy to DEV Database'
    steps:
    
    - checkout: self
      displayName: 'ï¿½ï¿½ Checkout Source Code'
    
    - script: |
        echo "$(environmentColor) Deploying to $(environmentName) Environment"
        echo "Database: $(databaseName)"
        echo "Version: $(majorVersion).$(minorVersion).$(patchVersion)"
        echo "Auto-approval: $(autoApproval)"
        echo ""
        echo "ðŸ“„ Files to deploy:"
        find sql/ -name "*.sql" -type f
      displayName: 'ðŸ“‹ Environment Info'
    
    - script: |
        echo "ðŸ“¦ Installing dependencies..."
        pip3 install pymssql
        echo "âœ… Dependencies installed"
      displayName: 'ðŸ“¦ Install Dependencies'
    
    - script: |
        echo "ðŸš€ Deploying SQL changes to $(environmentName)..."
        
        python3 << 'EOF'
        import pymssql
        import sys
        
        server = '$(sqlServerName)'
        database = '$(databaseName)'
        username = '$(sqlUsername)'
        password = '$(sqlPassword)'
        
        try:
            print(f"ðŸ“¡ Connecting to: {server}")
            print(f"ðŸ“Š Database: {database}")
            
            # Read SQL file
            with open('sql/create_customers_table.sql', 'r') as file:
                sql_script = file.read()
            
            print("ðŸ“œ Executing SQL script...")
            
            # Connect and execute
            conn = pymssql.connect(
                server=server,
                user=username,
                password=password,
                database=database,
                timeout=30
            )
            
            cursor = conn.cursor()
            cursor.execute(sql_script)
            conn.commit()
            
            print("âœ… SQL script executed successfully!")
            
            # Show deployment results
            cursor.execute("SELECT COUNT(*) FROM customers")
            count = cursor.fetchone()[0]
            print(f"ðŸ“Š $(environmentName): {count} customers in database")
            
            cursor.execute("SELECT TOP 3 Name, Email FROM customers ORDER BY CreatedDate DESC")
            recent_customers = cursor.fetchall()
            print("ðŸ‘¥ Recent customers:")
            for customer in recent_customers:
                print(f"  - {customer[0]} ({customer[1]})")
            
            conn.close()
            print("ðŸŽ‰ DEV deployment completed successfully!")
            
        except Exception as e:
            print(f"âŒ DEV deployment failed: {str(e)}")
            sys.exit(1)
        EOF
      displayName: 'ðŸš€ Deploy to DEV Database'

#==========================================
# PRE-PROD ENVIRONMENT (Auto if DEV passes)
#==========================================
- stage: DeployPreProd
  displayName: 'ðŸ§ª Deploy to Pre-Production'
  dependsOn: DeployDev
  condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/main'))
  variables:
  - template: environments/preprod/config.yml
  jobs:
  - job: DeployToPreProdDB
    displayName: 'Deploy to PRE-PROD Database'
    steps:
    
    - checkout: self
    
    - script: |
        echo "$(environmentColor) Deploying to $(environmentName) Environment"
        echo "Database: $(databaseName)"
        echo "Run tests: $(runTests)"
        pip3 install pymssql
      displayName: 'ðŸ“¦ Setup PRE-PROD Deployment'
    
    - script: |
        echo "ðŸš€ Deploying SQL changes to $(environmentName)..."
        
        python3 << 'EOF'
        import pymssql
        import sys
        
        server = '$(sqlServerName)'
        database = '$(databaseName)'
        username = '$(sqlUsername)'
        password = '$(sqlPassword)'
        
        try:
            with open('sql/create_customers_table.sql', 'r') as file:
                sql_script = file.read()
            
            conn = pymssql.connect(
                server=server,
                user=username,
                password=password,
                database=database,
                timeout=30
            )
            
            cursor = conn.cursor()
            cursor.execute(sql_script)
            conn.commit()
            
            # Verify deployment
            cursor.execute("SELECT COUNT(*) FROM customers")
            count = cursor.fetchone()[0]
            print(f"âœ… PRE-PROD: {count} customers in database")
            
            conn.close()
            print("ðŸŽ‰ PRE-PROD deployment completed!")
            
        except Exception as e:
            print(f"âŒ PRE-PROD deployment failed: {str(e)}")
            sys.exit(1)
        EOF
      displayName: 'ðŸš€ Deploy to PRE-PROD Database'
      
  - job: RunDataQualityTests
    displayName: 'Run Data Quality Tests'
    dependsOn: DeployToPreProdDB
    condition: eq(variables['runTests'], 'true')
    steps:
    
    - checkout: self
    
    - script: |
        echo "ðŸ§ª Running data quality tests in $(environmentName)..."
        
        # Set environment variables for the test script
        export SQL_SERVER='$(sqlServerName)'
        export SQL_DATABASE='$(databaseName)'
        export SQL_USERNAME='$(sqlUsername)'
        export SQL_PASSWORD='$(sqlPassword)'
        
        # Run the tests
        python3 tests/data_quality_tests.py
        
        if [ $? -eq 0 ]; then
            echo "ðŸŽ‰ All data quality tests passed in PRE-PROD!"
        else
            echo "âŒ Data quality tests failed in PRE-PROD!"
            exit 1
        fi
      displayName: 'ðŸ§ª Validate Data Quality'

#==========================================
# PROD ENVIRONMENT (Manual approval required)
#==========================================
- stage: ApproveProduction
  displayName: 'â¸ï¸ Production Approval Gate'
  dependsOn: DeployPreProd
  condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/main'))
  jobs:
  - job: waitForValidation
    displayName: 'Wait for Manual Approval'
    pool: server
    timeoutInMinutes: 1440 # 24 hours
    steps:
    - task: ManualValidation@0
      timeoutInMinutes: 1440
      inputs:
        notifyUsers: |
          # Add your email here for notifications
        instructions: |
          ðŸš€ **PRODUCTION DEPLOYMENT APPROVAL REQUIRED**
          
          **Environment:** Production Database (prod-customers-db)
          **Version:** $(majorVersion).$(minorVersion).$(patchVersion)
          **Changes:** Customer table deployment
          
          **Pre-checks completed:**
          âœ… DEV deployment successful
          âœ… PRE-PROD deployment successful  
          âœ… Data quality tests passed
          
          **Please review and approve for PRODUCTION deployment.**
          
          âš ï¸ This will affect the live production database.

- stage: DeployProd
  displayName: 'ðŸš€ Deploy to Production'
  dependsOn: ApproveProduction
  condition: succeeded()
  variables:
  - template: environments/prod/config.yml
  jobs:
  - deployment: DeployToProdDB
    displayName: 'Deploy to PRODUCTION Database'
    environment: 'production'
    strategy:
      runOnce:
        deploy:
          steps:
          
          - checkout: self
          
          - script: |
              echo "$(environmentColor) DEPLOYING TO $(environmentName) - LIVE ENVIRONMENT"
              echo "Database: $(databaseName)"
              echo "âš ï¸  THIS IS PRODUCTION - PROCEED WITH CAUTION"
              pip3 install pymssql
            displayName: 'ðŸš€ Setup PRODUCTION Deployment'
          
          - script: |
              echo "ðŸš€ Deploying SQL changes to PRODUCTION..."
              
              python3 << 'EOF'
              import pymssql
              import sys
              
              server = '$(sqlServerName)'
              database = '$(databaseName)'
              username = '$(sqlUsername)'
              password = '$(sqlPassword)'
              
              try:
                  print("âš ï¸  PRODUCTION DEPLOYMENT STARTING...")
                  
                  with open('sql/create_customers_table.sql', 'r') as file:
                      sql_script = file.read()
                  
                  conn = pymssql.connect(
                      server=server,
                      user=username,
                      password=password,
                      database=database,
                      timeout=30
                  )
                  
                  cursor = conn.cursor()
                  cursor.execute(sql_script)
                  conn.commit()
                  
                  # Verify production deployment
                  cursor.execute("SELECT COUNT(*) FROM customers")
                  count = cursor.fetchone()[0]
                  print(f"âœ… PRODUCTION: {count} customers in database")
                  
                  conn.close()
                  print("ðŸŽ‰ PRODUCTION DEPLOYMENT SUCCESSFUL!")
                  
              except Exception as e:
                  print(f"âŒ PRODUCTION deployment failed: {str(e)}")
                  sys.exit(1)
              EOF
            displayName: 'ðŸš€ Deploy to PRODUCTION Database'
            
  - job: ProductionValidation
    displayName: 'Production Smoke Tests'
    dependsOn: DeployToProdDB
    steps:
    
    - checkout: self
    
    - script: |
        echo "ðŸ” Running production smoke tests..."
        
        export SQL_SERVER='$(sqlServerName)'
        export SQL_DATABASE='$(databaseName)'
        export SQL_USERNAME='$(sqlUsername)'
        export SQL_PASSWORD='$(sqlPassword)'
        
        python3 tests/data_quality_tests.py
        
        if [ $? -eq 0 ]; then
            echo "ðŸŽ‰ Production smoke tests passed!"
        else
            echo "âŒ Production smoke tests failed!"
            exit 1
        fi
      displayName: 'ðŸ” Validate Production Health'
      
  - job: NotifySuccess
    displayName: 'Notify Deployment Success'
    dependsOn: ProductionValidation
    steps:
    - script: |
        echo "ðŸŽ‰ðŸš€ PRODUCTION DEPLOYMENT COMPLETED SUCCESSFULLY! ðŸš€ðŸŽ‰"
        echo ""
        echo "âœ… All environments deployed:"
        echo "  ðŸ”§ DEV: dev-customers-db"
        echo "  ðŸ§ª PRE-PROD: preprod-customers-db"  
        echo "  ðŸš€ PROD: prod-customers-db"
        echo ""
        echo "âœ… All tests passed"
        echo "âœ… Data quality validated"
        echo "âœ… Production health confirmed"
        echo ""
        echo "Version $(majorVersion).$(minorVersion).$(patchVersion) is now live!"
      displayName: 'ðŸŽ‰ Deployment Success Notification'
